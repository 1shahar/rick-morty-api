name: rick and morty api

on:
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: ccheckout code
        uses: actions/checkout@v4

      - name: update and upgrade system
        run: sudo apt update && sudo apt upgrade 

  deploy:
    needs: update
    runs-on: ubuntu-latest
    steps:
      - name: checkout code
        uses: actions/checkout@v4

      - name: start minikube
        id: minikube
        uses: medyagh/setup-minikube@latest

      - name: apply YAMLs
        run: |
          cd /home/runner/work/rick-morty-api/rick-morty-api/3/yamls
          kubectl apply -f Deployment.yaml -f Service.yaml -f Ingress.yaml
      
      - name: Wait for apply
        run: sleep 30
        
      # - name: Get service URL 
      #   id: get-service-url 
      #   run: echo "SERVICE_URL=$(minikube service rick-morty-api-service --url)" >> $GITHUB_ENV 

  test: 
    needs: deploy 
    runs-on: ubuntu-latest 
    steps: 
      - name: Checkout code 
        uses: actions/checkout@v4 
      
      - name: test
        run: |
          MINIKUBE_IP=$(minikube ip)
          SERVICE_URL="http://${MINIKUBE_IP}:8080"  # Assuming your service runs on port 8080
          curl -f $SERVICE_URL || exit 1
